<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600&display=swap" rel="stylesheet">
<!-- Persian Date + Datepicker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

<title>ÙØ§Ú©ØªÙˆØ± Ø®Ø¯Ù…Ø§Øª Ùˆ Ù‚Ø·Ø¹Ø§Øª</title>
<style>
  :root{--b:#1f2937;--g:#f3f4f6;--line:#e5e7eb;--pri:#2563eb}
  *{box-sizing:border-box}
  body{font-family:"Vazirmatn";background:#fff;margin:0;padding:0;color:#111;font-feature-settings:"ss01" 1;font-variant-numeric:normal;}
  .container{max-width:1100px;margin:0px auto;}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);overflow:hidden}
  header{display:grid;grid-template-columns: repeat(3, 1fr);gap:12px;padding:16px;border-bottom:1px dashed var(--line)}
  h1{font-size:18px;margin:0;color:var(--b);font-size: 14px;}
  .meta,.customer{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .row{display:contents}
  label{font-size:14px;color:#555;display:flex;align-items:center;}
  input,select{font-family:"Vazirmatn";width:100%;padding:4px 8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  input[type="date"]{direction:ltr}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  button{font-family:"Vazirmatn";border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer}
  .btn-primary{background:var(--pri);border-color:var(--pri);color:#fff}
  .btn-danger{color:#b91c1c;border-color:#fecaca;background:#fff}
  table{width:100%;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#2b2b2b;border-bottom:1px solid var(--line);font-weight:500;color: white;}
  th,td{font-family:"Vazirmatn";border-bottom:1px solid var(--line);padding:5px 3px;text-align:center;font-size: 14px;color: black;}
  tbody td input{font-family:"Vazirmatn";width:100%;padding:0px 4px;border:1px solid var(--line);border-radius:10px}
  tbody tr:hover{background:#f9fafb}
  tfoot td{font-weight:700;background:#2b2b2b;color: white;}
  .checkbox{transform:scale(1.1)}
  .muted{color:#6b7280;font-size:15px}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px dashed var(--line)}
  tbody tr.selected {
  background: #dbeafe !important; /* Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù† */
}

  @media print{
    .actions,.footer .print-hint{display:none}
    body{background:#fff}
    .card{box-shadow:none;border:none}
    input{border:0}
    thead th{position:static}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div style="text-align:right">
          <div class="muted">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù¾Ø°ÛŒØ±Ø´: 09363611918</div>
          <div class="muted" style="display:flex;align-items:center;justify-content:space-between;">
            <div>Ù†ÛŒÚ©Ù€Ù€Ø±Ø§Ù† Ù…ÙˆØªÙˆØ± <br> Ø¨Ù†Ù„ÛŒ - Ú©ÛŒ ÙˆÛŒ</div>
            <div style="display:flex;border:2px solid black;border-radius:8px;padding:10px;font-weight:800;">2601</div>
            
          </div>
        </div>
        <div style="text-align: center;">
          <h1 style="font-weight: 800;">
            
            ØªØ¹Ù…ÛŒØ±Ú¯Ø§Ù‡ Ù…Ø¬Ø§Ø² Ùˆ Ø®Ø¯Ù…Ø§Øª Ù¾Ø³ Ø§Ø² ÙØ±ÙˆØ´ </br>Ù…ÙˆØªÙˆØ± Ø³ÛŒÚ©Ù„Øª Ù…Ø±Ø§Ø¯ÛŒØ§Ù† 
          
          </h1>
          <div style="font-size: 10px;" class="muted">Ø¢Ø¯Ø±Ø³: Ú©Ø±Ø¬ ØŒ Ø¬Ø§Ø¯Ù‡ Ù…Ù„Ø§Ø±Ø¯ ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† Ø§Ù‡Ø±ÛŒ ØŒ Ù†Ø¨Ø´ Ù†Ø³ØªØ±Ù† 58 ØŒ Ø±ÙˆØ¨Ø±Ùˆ Ø³ØªØ§Ø¯ ÙØ±Ù…Ø§Ù†Ø¯Ù‡ÛŒ </div>
        </div>
        <div style="text-align:left;display: flex;flex-direction: column;align-items: stretch;gap: 10px;">
           <div class="row" style="display: flex;">
            <label style="flex: 2;">ØªØ§Ø±ÛŒØ®</label>
            <input style="flex: 4;"  id="invDate" type="text" class="pdate">
          </div>
          <div class="row" style="display: flex;">
            <label style="flex: 2;">Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</label>
            <input style="flex: 4;" id="invNumber" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹ 2601">
          </div>
          </div>
        </div>
        
      </header>

      <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ± -->
      <div style="padding:14px 16px">
        <div class="meta">
         
          <div class="row">
            <label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ù…Ø´ØªØ±ÛŒ</label>
            <input id="customerName" type="text" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ">
          </div>
          <div class="row">
            <label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ù…Ø´ØªØ±ÛŒ</label>
            <input id="customerPhone" type="tel" placeholder="09xxxxxxxxx">
          </div>
        </div>

        <div class="actions">
          <button id="addRow" class="btn-primary">+ Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø·Ø±</button>
          <button id="removeRows" class="btn-danger">ğŸ—‘ Ø­Ø°Ù Ø³Ø·Ø±Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡</button>
          <!-- âœ… Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ -->
          <button id="saveInvoice">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ÙØ§Ú©ØªÙˆØ±</button>
          <button id="toggleManager">ğŸ“‚ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡</button>
          <span class="muted print-hint">Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾: Ctrl/Cmd + P</span>
        </div>

        <!-- âœ… Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø¯Ù‡ -->
        <div id="manager" style="display:none; border:1px solid var(--line); border-radius:12px; padding:12px; margin-top:10px">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <strong>ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡:</strong>
            <select id="savedList" style="min-width:320px; padding:8px 10px; border:1px solid var(--line); border-radius:10px"></select>
            <button id="loadSelected">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</button>
            <button id="deleteSelected" class="btn-danger">Ø­Ø°Ù</button>
          </div>
          <div class="muted" style="margin-top:6px">* Ø¨Ø± Ø§Ø³Ø§Ø³ Â«Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±Â» Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>

        <div style="overflow:auto; border:1px solid var(--line); border-radius:12px; margin-top:10px">
          <table id="invoiceTable">
  <thead>
    <tr>
      <th style="width:64px">Ø±Ø¯ÛŒÙ</th>
      <th>Ú©Ø¯ Ú©Ø§Ù„Ø§</th>
      <th>Ù†Ø§Ù… Ú©Ø§Ù„Ø§</th>
      <th style="width:110px">ØªØ¹Ø¯Ø§Ø¯</th>
      <th style="width:160px">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (Ø±ÛŒØ§Ù„)</th>
      <th style="width:180px">Ù…Ø¨Ù„Øº Ú©Ù„ (Ø±ÛŒØ§Ù„)</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
  <tfoot>
    <tr>
      <td colspan="5" style="text-align:left;padding-left:16px">Ø¬Ù…Ø¹ Ú©Ù„</td>
      <td><span id="grandTotal">0</span></td>
    </tr>
  </tfoot>
</table>

        </div>
      </div>

      <div class="footer">
        <div class="muted">Ø§Ù…Ø¶Ø§ Ù…Ø´ØªØ±ÛŒ: ....................................</div>
        <div class="muted">Ø§Ù…Ø¶Ø§ Ù…Ø³Ø¦ÙˆÙ„: ....................................</div>
      </div>
    </div>
  </div>

<script>
/* ===== Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ùˆ Ø³Ø·Ø±Ù‡Ø§ ===== */
const nf = new Intl.NumberFormat('en-US');
const tbody = document.getElementById('tbody');
const grandTotalEl = document.getElementById('grandTotal');

function parseNum(str = '') {
  return Number(String(str).replace(/[, ]/g, '')) || 0;
}
function formatNum(n) {
  return n ? nf.format(n) : '';
}

function newRow(values = {}) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="rowIndex">1</td>
    <td><input type="text" class="code" placeholder="Ú©Ø¯"></td>
    <td><input type="text" class="title" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§/Ø®Ø¯Ù…Øª"></td>
    <td><input type="number" min="0" step="1" class="qty" value="${values.qty ?? 1}"></td>
    <td><input type="text" inputmode="numeric" class="price" value="${formatNum(values.price ?? 0)}"></td>
    <td><input type="text" class="lineTotal" value="" readonly></td>
  `;

  const qtyInput = tr.querySelector('.qty');
  const priceInput = tr.querySelector('.price');

  priceInput.addEventListener('input', (e) => {
    const clean = parseNum(e.target.value);
    e.target.value = formatNum(clean);
    updateRow(tr);
  });
  qtyInput.addEventListener('input', () => updateRow(tr));

  // âœ… Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨/ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³Ø·Ø±
  tr.addEventListener('click', () => {
    tr.classList.toggle('selected');
  });

  tbody.appendChild(tr);
  refreshRowIndices();
  updateRow(tr);
}

function updateRow(tr) {
  const qty = parseNum(tr.querySelector('.qty').value);
  const price = parseNum(tr.querySelector('.price').value);
  const total = qty * price;
  tr.querySelector('.lineTotal').value = formatNum(total);
  updateGrandTotal();
}

function updateGrandTotal() {
  let sum = 0;
  [...tbody.querySelectorAll('.lineTotal')].forEach((inp) => (sum += parseNum(inp.value)));
  grandTotalEl.textContent = formatNum(sum);
}

function refreshRowIndices() {
  [...tbody.querySelectorAll('.rowIndex')].forEach((td, i) => (td.textContent = i + 1));
}

document.getElementById('addRow').addEventListener('click', () => newRow());

document.getElementById('removeRows').addEventListener('click', () => {
  const selected = [...tbody.querySelectorAll('tr.selected')];
  if (!selected.length) {
    alert('Ù‡ÛŒÚ† Ø³Ø·Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
    return;
  }
  selected.forEach((tr) => tr.remove());
  refreshRowIndices();
  updateGrandTotal();
});

/* ===== Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø³Ø·Ø± Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ ===== */
const style = document.createElement('style');
style.textContent = `
  tbody tr.selected {
    background: #dbeafe !important; /* Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù† */
  }
`;
document.head.appendChild(style);

/* ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ùˆ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ */
(function setToday() {
  const d = new Date();
  document.getElementById('invDate').value = d.toISOString().slice(0, 10);
})();
$(document).ready(function () {
  $('#invDate').persianDatepicker({
    format: 'YYYY/MM/DD',
    autoClose: true,
    initialValue: true,
    calendar: { persian: { locale: 'fa', leapYearMode: 'algorithmic' } },
  });
});
newRow({ qty: 1, price: 0 });

/* ===== âœ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± LocalStorage ===== */
const STORAGE_KEY = 'invoices_v1';

function getAllInvoices() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  } catch {
    return [];
  }
}
function setAllInvoices(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

// Ø³Ø§Ø®Øª Ø¢Ø¨Ø¬Ú©Øª ÙØ§Ú©ØªÙˆØ± Ø§Ø² ÙØ±Ù…
function collectInvoiceData() {
  const rows = [...tbody.querySelectorAll('tr')].map((tr) => ({
    code: tr.querySelector('.code')?.value || '',
    title: tr.querySelector('.title')?.value || '',
    qty: parseNum(tr.querySelector('.qty')?.value || '0'),
    price: parseNum(tr.querySelector('.price')?.value || '0'),
  }));
  return {
    id: (window.crypto?.randomUUID && crypto.randomUUID()) || String(Date.now()),
    date: document.getElementById('invDate').value,
    number: document.getElementById('invNumber').value.trim(),
    customerName: document.getElementById('customerName').value.trim(),
    customerPhone: document.getElementById('customerPhone').value.trim(),
    rows,
  };
}

// Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø§Ø² ÛŒÚ© ÙØ§Ú©ØªÙˆØ±
function loadInvoiceData(inv) {
  document.getElementById('invDate').value = inv.date || '';
  document.getElementById('invNumber').value = inv.number || '';
  document.getElementById('customerName').value = inv.customerName || '';
  document.getElementById('customerPhone').value = inv.customerPhone || '';

  tbody.innerHTML = '';
  inv.rows.forEach((r) => {
    newRow({ qty: r.qty, price: r.price });
  });
  [...tbody.querySelectorAll('tr')].forEach((tr, i) => {
    tr.querySelector('.code').value = inv.rows[i]?.code || '';
    tr.querySelector('.title').value = inv.rows[i]?.title || '';
    updateRow(tr);
  });
  updateGrandTotal();
}

// Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±
function saveCurrentInvoice() {
  const data = collectInvoiceData();
  if (!data.number) {
    if (!confirm('Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ± Ø®Ø§Ù„ÛŒ Ø§Ø³Øª. Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ Ø¯Ø§Ø®Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯ØŸ')) return;
  }
  const list = getAllInvoices();
  const idx = data.number ? list.findIndex((x) => x.number === data.number) : -1;
  if (idx >= 0) {
    data.id = list[idx].id;
    list[idx] = data;
  } else {
    list.unshift(data);
  }
  setAllInvoices(list);
  alert('ÙØ§Ú©ØªÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ âœ…');
  refreshSavedList();
}

// Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø¯Ø± Ø³Ù„Ú©Øª
const manager = document.getElementById('manager');
const savedList = document.getElementById('savedList');

function refreshSavedList() {
  const list = getAllInvoices();
  savedList.innerHTML = '';
  list.forEach((inv) => {
    const title = `${inv.number || 'Ø¨Ø¯ÙˆÙ† Ø´Ù…Ø§Ø±Ù‡'} â€” ${inv.customerName || 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…'} â€” ${inv.date || ''}`;
    const opt = new Option(title, inv.id);
    savedList.add(opt);
  });
}

// Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª
document.getElementById('saveInvoice').addEventListener('click', saveCurrentInvoice);
document.getElementById('toggleManager').addEventListener('click', () => {
  manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
  refreshSavedList();
});
document.getElementById('loadSelected').addEventListener('click', () => {
  const id = savedList.value;
  const inv = getAllInvoices().find((x) => x.id === id);
  if (!inv) return alert('Ù…ÙˆØ±Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
  loadInvoiceData(inv);
});
document.getElementById('deleteSelected').addEventListener('click', () => {
  const id = savedList.value;
  if (!id) return alert('Ù…ÙˆØ±Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
  if (!confirm('Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
  const list = getAllInvoices().filter((x) => x.id !== id);
  setAllInvoices(list);
  refreshSavedList();
});
</script>

</body>
</html>
